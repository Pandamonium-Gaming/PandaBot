#!/bin/bash
# Pre-commit hook to validate version synchronization between .csproj and CHANGELOG.md

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Validating version synchronization...${NC}"

# Extract version from .csproj
CSPROJ_FILE="src/PandaBot/PandaBot.csproj"
if [ ! -f "$CSPROJ_FILE" ]; then
    echo -e "${RED}‚ùå Error: $CSPROJ_FILE not found${NC}"
    exit 1
fi

CSPROJ_VERSION=$(grep -oP '<Version>\K[^<]+' "$CSPROJ_FILE" 2>/dev/null || echo "")
if [ -z "$CSPROJ_VERSION" ]; then
    echo -e "${RED}‚ùå Error: Could not extract version from $CSPROJ_FILE${NC}"
    exit 1
fi

echo -e "üì¶ Version in .csproj: ${GREEN}$CSPROJ_VERSION${NC}"

# Extract version from CHANGELOG.md
CHANGELOG_FILE="CHANGELOG.md"
if [ ! -f "$CHANGELOG_FILE" ]; then
    echo -e "${RED}‚ùå Error: $CHANGELOG_FILE not found${NC}"
    exit 1
fi

# Get the first version entry (should be at the top)
CHANGELOG_VERSION=$(grep -oP '## \[\K[^\]]+' "$CHANGELOG_FILE" 2>/dev/null | head -1 || echo "")
if [ -z "$CHANGELOG_VERSION" ]; then
    echo -e "${RED}‚ùå Error: Could not extract version from $CHANGELOG_FILE${NC}"
    exit 1
fi

echo -e "üìù Version in CHANGELOG: ${GREEN}$CHANGELOG_VERSION${NC}"

# Compare versions
if [ "$CSPROJ_VERSION" != "$CHANGELOG_VERSION" ]; then
    echo -e "\n${RED}‚ùå Version Mismatch!${NC}"
    echo -e "   .csproj version:   ${RED}$CSPROJ_VERSION${NC}"
    echo -e "   CHANGELOG version: ${RED}$CHANGELOG_VERSION${NC}"
    echo ""
    echo -e "${YELLOW}üìã Fix this by:${NC}"
    echo "   1. Update version in $CSPROJ_FILE to match CHANGELOG"
    echo "   2. OR update CHANGELOG to match .csproj version"
    echo "   3. Make sure CHANGELOG entry is: ## [$CSPROJ_VERSION] - YYYY-MM-DD"
    echo ""
    exit 1
fi

echo -e "\n${GREEN}‚úÖ Versions match! Proceeding with commit...${NC}"
exit 0
