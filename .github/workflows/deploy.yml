name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'src/PandaBot/PandaBot.csproj'
  DEPLOY_USER: 'deployment'
  DEPLOY_PATH: '/opt/pandabot'

# Required secrets: DEPLOY_SSH_KEY, DEPLOY_HOST, DISCORD_TOKEN

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Clear NuGet cache
      run: dotnet nuget locals all --clear
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }} --verbosity diagnostic
    
    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore
    
    - name: Publish
      run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --no-build --output ./publish
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: Stop bot service
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "sudo systemctl stop pandabot.service || true"
    
    - name: Deploy files
      run: |
        rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./publish/ ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/
    
    - name: Set permissions
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "sudo chown -R ${{ env.DEPLOY_USER }}:${{ env.DEPLOY_USER }} ${{ env.DEPLOY_PATH }} && \
           chmod +x ${{ env.DEPLOY_PATH }}/PandaBot"
    
    - name: Create/Update .env file
      run: |
        cat > /tmp/pandabot.env << EOF
PANDABOT_Discord__Token=${{ secrets.DISCORD_TOKEN }}
PANDABOT_Discord__Prefix=!
PANDABOT_ConnectionStrings__DefaultConnection=Data Source=${{ env.DEPLOY_PATH }}/pandabot.db
PANDABOT_AshesForge__CacheExpirationHours=24
PANDABOT_AshesForge__EnableImageCaching=true
EOF
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/pandabot.env ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/.env
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "chmod 600 ${{ env.DEPLOY_PATH }}/.env"
        rm /tmp/pandabot.env
    
    - name: Start bot service
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "sudo systemctl start pandabot.service"
    
    - name: Check service status
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "sudo systemctl status pandabot.service --no-pager"
    
    - name: Cleanup SSH key
      if: always()
      run: rm -f ~/.ssh/deploy_key
